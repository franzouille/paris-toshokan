<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Bibliothèques Paris · Launcher</title>
  <meta name="theme-color" content="#0b1220" />
  <style>
    :root {
      --bg-top: #0b1220;
      --bg-bottom: #0f1b33;
      --text-main: #e5e7eb;
      --text-muted: #94a3b8;
      --border: rgba(148, 163, 184, 0.2);
      --panel-bg: rgba(255, 255, 255, 0.05);
      --field-bg: rgba(11, 18, 32, 0.55);
      --shadow: 0 20px 60px rgba(0, 0, 0, 0.45);
      --radius-lg: 18px;
      --radius-md: 14px;
      --accent: #60a5fa;
      --accent-2: #22c55e;
      --focus-ring: 0 0 0 4px rgba(96, 165, 250, 0.25);
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      min-height: 100vh;
      padding: 18px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--text-main);
      font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      background:
        radial-gradient(1200px 600px at 10% 0%, rgba(96, 165, 250, 0.25), transparent 60%),
        radial-gradient(1000px 600px at 90% 10%, rgba(34, 197, 94, 0.2), transparent 55%),
        linear-gradient(180deg, var(--bg-top), var(--bg-bottom));
    }

    .app {
      width: min(860px, 100%);
      display: grid;
      gap: 14px;
    }

    .app-header {
      display: flex;
      align-items: flex-start;
      justify-content: space-between;
      gap: 12px;
    }

    .app-title {
      margin: 0;
      font-size: clamp(20px, 2.8vw, 28px);
      letter-spacing: 0.2px;
    }

    .app-subtitle {
      margin: 6px 0 0;
      color: var(--text-muted);
      font-size: 14px;
      line-height: 1.35;
    }

    .status-badge {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 8px 10px;
      border: 1px solid var(--border);
      border-radius: 999px;
      background: rgba(255, 255, 255, 0.04);
      color: var(--text-muted);
      font-size: 12px;
      white-space: nowrap;
      user-select: none;
    }

    .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 999px;
      background: var(--accent-2);
      box-shadow: 0 0 0 4px rgba(34, 197, 94, 0.15);
    }

    .panel {
      overflow: hidden;
      border: 1px solid var(--border);
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow);
      background: linear-gradient(180deg, rgba(255, 255, 255, 0.06), rgba(255, 255, 255, 0.03));
    }

    .panel-body {
      padding: 16px;
      display: grid;
      gap: 14px;
    }

    .top-grid {
      display: grid;
      grid-template-columns: 1.4fr 0.9fr;
      gap: 12px;
      align-items: start;
    }

    .section-label {
      margin: 0 0 8px;
      color: var(--text-muted);
      font-size: 13px;
    }

    .search-field {
      position: relative;
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 12px;
      border: 1px solid var(--border);
      border-radius: var(--radius-md);
      background: var(--field-bg);
      backdrop-filter: blur(8px);
    }

    .search-field svg {
      flex: 0 0 auto;
      opacity: 0.9;
    }

    .search-input {
      width: 100%;
      border: 0;
      outline: none;
      background: transparent;
      color: var(--text-main);
      font-size: 16px;
    }

    .search-input::placeholder {
      color: rgba(148, 163, 184, 0.8);
    }

    .search-field:focus-within {
      border-color: rgba(96, 165, 250, 0.6);
      box-shadow: var(--focus-ring);
    }

    .preset-select {
      width: 100%;
      padding: 12px;
      border: 1px solid var(--border);
      border-radius: var(--radius-md);
      outline: none;
      color: var(--text-main);
      background: var(--field-bg);
      font-size: 14px;
    }

    .preset-select:focus {
      border-color: rgba(96, 165, 250, 0.6);
      box-shadow: var(--focus-ring);
    }

    .hint {
      color: var(--text-muted);
      font-size: 13px;
      line-height: 1.35;
    }

    .types-box {
      display: flex;
      align-items: center;
      gap: 10px;
      flex-wrap: wrap;
      padding: 10px 12px;
      border: 1px solid var(--border);
      border-radius: var(--radius-md);
      background: rgba(11, 18, 32, 0.35);
    }

    .type-pill {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      font-size: 14px;
      color: var(--text-main);
      user-select: none;
    }

    .type-pill input {
      width: 16px;
      height: 16px;
    }

    .actions-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      flex-wrap: wrap;
    }

    .action-group {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }

    .btn {
      appearance: none;
      border: 0;
      border-radius: var(--radius-md);
      padding: 12px 14px;
      display: inline-flex;
      align-items: center;
      gap: 10px;
      cursor: pointer;
      user-select: none;
      font-size: 15px;
      font-weight: 650;
      color: #07101f;
      background: linear-gradient(180deg, #60a5fa, #3b82f6);
      box-shadow: 0 10px 24px rgba(59, 130, 246, 0.25);
      transition: transform 0.08s ease, filter 0.15s ease;
    }

    .btn:active {
      transform: translateY(1px);
    }

    .btn.secondary {
      color: var(--text-main);
      font-weight: 600;
      border: 1px solid var(--border);
      background: rgba(255, 255, 255, 0.06);
      box-shadow: none;
    }

    .btn.secondary:hover {
      filter: brightness(1.08);
    }

    .btn:focus {
      outline: none;
    }

    .btn:focus-visible {
      box-shadow: var(--focus-ring);
    }

    .quick-chips {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    .chip {
      border: 1px solid var(--border);
      border-radius: 999px;
      padding: 8px 10px;
      color: var(--text-main);
      background: rgba(255, 255, 255, 0.04);
      font-size: 13px;
      cursor: pointer;
      user-select: none;
      transition: filter 0.15s ease, transform 0.08s ease;
    }

    .chip:hover {
      filter: brightness(1.1);
    }

    .chip:active {
      transform: translateY(1px);
    }

    .chip small {
      margin-left: 6px;
      font-size: 12px;
      color: var(--text-muted);
    }

    .panel-footer {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      flex-wrap: wrap;
      padding: 12px 16px;
      border-top: 1px solid var(--border);
      background: rgba(0, 0, 0, 0.15);
    }

    .remember-wrap {
      display: inline-flex;
      align-items: center;
      gap: 10px;
      user-select: none;
      color: var(--text-muted);
      font-size: 13px;
    }

    .remember-switch {
      position: relative;
      width: 44px;
      height: 26px;
      flex: 0 0 auto;
      border: 1px solid var(--border);
      border-radius: 999px;
      background: rgba(255, 255, 255, 0.06);
      cursor: pointer;
    }

    .remember-knob {
      position: absolute;
      top: 2px;
      left: 2px;
      width: 20px;
      height: 20px;
      border-radius: 999px;
      background: rgba(229, 231, 235, 0.9);
      transition: transform 0.18s ease, background 0.18s ease;
    }

    .remember-switch.on {
      border-color: rgba(34, 197, 94, 0.35);
      background: rgba(34, 197, 94, 0.18);
    }

    .remember-switch.on .remember-knob {
      transform: translateX(18px);
      background: rgba(34, 197, 94, 0.95);
    }

    @media (max-width: 740px) {
      .top-grid {
        grid-template-columns: 1fr;
      }
    }

    @media (max-width: 520px) {
      .panel-body {
        padding: 14px;
      }

      .app-header {
        flex-direction: column;
        align-items: flex-start;
      }

      .status-badge {
        align-self: flex-start;
      }

      .btn {
        flex: 1 1 auto;
        justify-content: center;
      }
    }
  </style>
</head>
<body>
  <main class="app">
    <header class="app-header">
      <div>
        <h1 class="app-title">Bibliothèques Paris · Recherche rapide</h1>
        <p class="app-subtitle">Choisis un preset, tape un terme, ouvre la recherche avec tes filtres.</p>
      </div>
      <div class="status-badge"><span class="status-dot"></span> Prêt</div>
    </header>

    <section class="panel" aria-label="Lanceur de recherche">
      <div class="panel-body">
        <div class="top-grid">
          <div>
            <p class="section-label">Recherche</p>
            <label class="search-field" for="queryInput">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                <path d="M10.5 18a7.5 7.5 0 1 1 0-15 7.5 7.5 0 0 1 0 15Z" stroke="rgba(229,231,235,.9)" stroke-width="2" />
                <path d="M16.5 16.5 21 21" stroke="rgba(229,231,235,.9)" stroke-width="2" stroke-linecap="round" />
              </svg>
              <input id="queryInput" class="search-input" autocomplete="off" placeholder="Ex : homo sapiens tome 2, tardi burma, tintin..." />
            </label>
          </div>

          <div>
            <p class="section-label">Preset</p>
            <select id="presetSelect" class="preset-select"></select>
            <div class="hint" id="presetHint" style="margin-top:8px;"></div>
          </div>
        </div>

        <div>
          <p class="section-label">Type de document</p>
          <div class="types-box">
            <label class="type-pill"><input type="checkbox" id="bookType" checked /> Livre</label>
            <label class="type-pill"><input type="checkbox" id="bdType" checked /> BD</label>
            <span class="hint" id="typeHint"></span>
          </div>
        </div>

        <div class="actions-row">
          <div class="action-group">
            <button class="btn" id="openHereBtn" type="button">Ouvrir ici <span aria-hidden="true">↗</span></button>
            <button class="btn secondary" id="openNewTabBtn" type="button">Nouvel onglet <span aria-hidden="true">⤢</span></button>
            <button class="btn secondary" id="clearBtn" type="button">Effacer</button>
          </div>
          <div class="hint" id="queryHint"></div>
        </div>

        <div class="quick-chips" aria-label="Recherches rapides">
          <button class="chip" type="button" data-query="homo sapiens tome 2">homo sapiens <small>tome 2</small></button>
          <button class="chip" type="button" data-query="tardi burma">tardi <small>burma</small></button>
          <button class="chip" type="button" data-query="sapiens tome 1">sapiens <small>tome 1</small></button>
          <button class="chip" type="button" data-query="corto maltese">corto <small>maltese</small></button>
        </div>
      </div>

      <footer class="panel-footer">
        <div class="remember-wrap">
          <div class="remember-switch" id="rememberSwitch" role="switch" aria-checked="false" tabindex="0">
            <div class="remember-knob"></div>
          </div>
          <span>Se souvenir de ma dernière recherche</span>
        </div>

        <div class="hint">Astuce : “Ajouter à l’écran d’accueil” pour un accès 1 tap.</div>
      </footer>
    </section>
  </main>

  <script>
    const PRESETS = [
      {
        id: "p13",
        label: "75013 · Italie + J.-P. Melville + Virginia Woolf",
        libraries: [
          "75013 - Italie",
          "75013 - Jean-Pierre Melville",
          "75013 - Virginia Woolf"
        ]
      }
    ];

    const STORAGE_KEYS = {
      query: "pbux_last_query",
      remember: "pbux_remember",
      preset: "pbux_preset",
      types: "pbux_types"
    };

    const DOM = {
      queryInput: document.getElementById("queryInput"),
      presetSelect: document.getElementById("presetSelect"),
      presetHint: document.getElementById("presetHint"),
      bookType: document.getElementById("bookType"),
      bdType: document.getElementById("bdType"),
      typeHint: document.getElementById("typeHint"),
      queryHint: document.getElementById("queryHint"),
      openHereBtn: document.getElementById("openHereBtn"),
      openNewTabBtn: document.getElementById("openNewTabBtn"),
      clearBtn: document.getElementById("clearBtn"),
      rememberSwitch: document.getElementById("rememberSwitch"),
      quickChips: document.querySelectorAll(".chip[data-query]")
    };

    function getSelectedTypes() {
      const types = [];
      if (DOM.bookType.checked) types.push("Livre");
      if (DOM.bdType.checked) types.push("BD");
      return types.length ? types : ["Livre", "BD"];
    }

    function encodeFacetFilter(libraries, types) {
      const facetObject = {
        _587: libraries.join("||"),
        _586: types.join("||")
      };
      return encodeURIComponent(JSON.stringify(facetObject));
    }

    function buildSearchUrl(query, presetId) {
      const encodedQuery = encodeURIComponent(query);
      const selectedPreset = PRESETS.find((preset) => preset.id === presetId) || PRESETS[0];
      const facetFilter = encodeFacetFilter(selectedPreset.libraries, getSelectedTypes());

      return "https://bibliotheques.paris.fr/search.aspx#/Search/(query:(CloudTerms:!(),FacetFilter:'"
        + facetFilter
        + "',ForceSearch:!t,InitialSearch:!f,Page:0,PageRange:3,QueryGuid:'',QueryString:'"
        + encodedQuery
        + "',ResultSize:50,ScenarioCode:CATALOGUE,ScenarioDisplayMode:display-standard,SearchGridFieldsShownOnResultsDTO:!(),SearchLabel:'',SearchTerms:'"
        + encodedQuery
        + "',SortField:!n,SortOrder:0,TemplateParams:(Scenario:'',Scope:Default,Size:!n,Source:'',Support:'',UseCompact:!f),UseSpellChecking:!n),sst:4)";
    }

    function focusQueryInput() {
      DOM.queryInput.focus();
      DOM.queryInput.setSelectionRange(DOM.queryInput.value.length, DOM.queryInput.value.length);
    }

    function getRememberPreference() {
      return localStorage.getItem(STORAGE_KEYS.remember) === "1";
    }

    function setRememberPreference(isEnabled) {
      localStorage.setItem(STORAGE_KEYS.remember, isEnabled ? "1" : "0");
      DOM.rememberSwitch.classList.toggle("on", isEnabled);
      DOM.rememberSwitch.setAttribute("aria-checked", isEnabled ? "true" : "false");
    }

    function saveQueryIfRemembered(query) {
      if (getRememberPreference() && query) {
        localStorage.setItem(STORAGE_KEYS.query, query);
      }
    }

    function savePresetSelection(presetId) {
      localStorage.setItem(STORAGE_KEYS.preset, presetId);
    }

    function loadPresetSelection() {
      const savedPreset = localStorage.getItem(STORAGE_KEYS.preset);
      const validSavedPreset = PRESETS.some((preset) => preset.id === savedPreset);
      return validSavedPreset ? savedPreset : PRESETS[0].id;
    }

    function saveTypeSelection() {
      localStorage.setItem(
        STORAGE_KEYS.types,
        JSON.stringify({
          book: DOM.bookType.checked,
          bd: DOM.bdType.checked
        })
      );
    }

    function loadTypeSelection() {
      try {
        const saved = localStorage.getItem(STORAGE_KEYS.types);
        if (!saved) return null;
        const parsed = JSON.parse(saved);
        return { book: !!parsed.book, bd: !!parsed.bd };
      } catch {
        return null;
      }
    }

    function refreshTypeHint() {
      const selected = [];
      if (DOM.bookType.checked) selected.push("Livre");
      if (DOM.bdType.checked) selected.push("BD");
      DOM.typeHint.textContent = selected.length
        ? `Types : ${selected.join(" + ")}`
        : "Types : (aucun) → fallback Livre + BD";
    }

    function refreshQueryHint() {
      const query = DOM.queryInput.value.trim();
      DOM.queryHint.textContent = query ? `Recherche : “${query}”` : "";
      refreshTypeHint();
    }

    function refreshPresetHint() {
      const presetId = DOM.presetSelect.value;
      const selectedPreset = PRESETS.find((preset) => preset.id === presetId);
      DOM.presetHint.textContent = selectedPreset
        ? `Bibliothèques : ${selectedPreset.libraries.join(" · ")}`
        : "";
      if (selectedPreset) {
        savePresetSelection(presetId);
      }
    }

    function setQuery(query) {
      DOM.queryInput.value = query;
      refreshQueryHint();
      saveQueryIfRemembered(query);
      focusQueryInput();
    }

    function clearQuery() {
      setQuery("");
      localStorage.removeItem(STORAGE_KEYS.query);
    }

    function toggleRememberPreference() {
      const nextValue = !getRememberPreference();
      setRememberPreference(nextValue);

      const currentQuery = DOM.queryInput.value.trim();
      if (nextValue && currentQuery) {
        localStorage.setItem(STORAGE_KEYS.query, currentQuery);
      }
      if (!nextValue) {
        localStorage.removeItem(STORAGE_KEYS.query);
      }
    }

    function openSearch(openInNewTab) {
      const query = DOM.queryInput.value.trim();
      if (!query) {
        refreshQueryHint();
        focusQueryInput();
        return;
      }

      saveQueryIfRemembered(query);
      saveTypeSelection();

      const url = buildSearchUrl(query, DOM.presetSelect.value);
      if (openInNewTab) {
        window.open(url, "_blank", "noopener,noreferrer");
      } else {
        location.href = url;
      }
    }

    function initPresetOptions() {
      DOM.presetSelect.innerHTML = "";
      PRESETS.forEach((preset) => {
        const option = document.createElement("option");
        option.value = preset.id;
        option.textContent = preset.label;
        DOM.presetSelect.appendChild(option);
      });

      DOM.presetSelect.value = loadPresetSelection();
      refreshPresetHint();
    }

    function initStoredState() {
      setRememberPreference(getRememberPreference());

      const lastQuery = localStorage.getItem(STORAGE_KEYS.query);
      if (getRememberPreference() && lastQuery) {
        DOM.queryInput.value = lastQuery;
      }

      const savedTypes = loadTypeSelection();
      if (savedTypes) {
        DOM.bookType.checked = savedTypes.book;
        DOM.bdType.checked = savedTypes.bd;
      }

      refreshQueryHint();
      setTimeout(focusQueryInput, 50);
    }

    function bindEvents() {
      DOM.presetSelect.addEventListener("change", refreshPresetHint);

      DOM.queryInput.addEventListener("input", () => {
        refreshQueryHint();
        saveQueryIfRemembered(DOM.queryInput.value.trim());
      });

      DOM.queryInput.addEventListener("keydown", (event) => {
        if (event.key === "Enter") {
          openSearch(false);
        }
      });

      DOM.bookType.addEventListener("change", () => {
        refreshTypeHint();
        saveTypeSelection();
      });

      DOM.bdType.addEventListener("change", () => {
        refreshTypeHint();
        saveTypeSelection();
      });

      DOM.openHereBtn.addEventListener("click", () => openSearch(false));
      DOM.openNewTabBtn.addEventListener("click", () => openSearch(true));
      DOM.clearBtn.addEventListener("click", clearQuery);

      DOM.quickChips.forEach((chip) => {
        chip.addEventListener("click", () => {
          setQuery(chip.dataset.query || "");
          openSearch(false);
        });
      });

      DOM.rememberSwitch.addEventListener("click", toggleRememberPreference);
      DOM.rememberSwitch.addEventListener("keydown", (event) => {
        if (event.key === "Enter" || event.key === " ") {
          event.preventDefault();
          toggleRememberPreference();
        }
      });
    }

    initPresetOptions();
    bindEvents();
    initStoredState();
  </script>
</body>
</html>
